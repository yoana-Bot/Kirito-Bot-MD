const handler = async (m, { isOwner, isAdmin, conn, text, participants, args, command, usedPrefix }) => {
  if (usedPrefix.toLowerCase() === 'a') return;

  const customEmoji = global.db?.data?.chats?.[m.chat]?.customEmoji || 'ðŸ”¥';
  m.react(customEmoji);

  if (!(isAdmin || isOwner)) {
    global.dfail('admin', m, conn);
    return;
  }

  const countryFlags = {
    "1": "ðŸ‡ºðŸ‡¸", "7": "ðŸ‡·ðŸ‡º", "20": "ðŸ‡ªðŸ‡¬", "27": "ðŸ‡¿ðŸ‡¦", "30": "ðŸ‡¬ðŸ‡·", "31": "ðŸ‡³ðŸ‡±",
  "32": "ðŸ‡§ðŸ‡ª", "33": "ðŸ‡«ðŸ‡·", "34": "ðŸ‡ªðŸ‡¸", "36": "ðŸ‡­ðŸ‡º", "39": "ðŸ‡®ðŸ‡¹", "40": "ðŸ‡·ðŸ‡´",
  "41": "ðŸ‡¨ðŸ‡­", "43": "ðŸ‡¦ðŸ‡¹", "44": "ðŸ‡¬ðŸ‡§", "45": "ðŸ‡©ðŸ‡°", "46": "ðŸ‡¸ðŸ‡ª", "47": "ðŸ‡³ðŸ‡´",
  "48": "ðŸ‡µðŸ‡±", "49": "ðŸ‡©ðŸ‡ª", "51": "ðŸ‡µðŸ‡ª", "52": "ðŸ‡²ðŸ‡½", "53": "ðŸ‡¨ðŸ‡º", "54": "ðŸ‡¦ðŸ‡·",
  "55": "ðŸ‡§ðŸ‡·", "56": "ðŸ‡¨ðŸ‡±", "57": "ðŸ‡¨ðŸ‡´", "58": "ðŸ‡»ðŸ‡ª", "60": "ðŸ‡²ðŸ‡¾", "61": "ðŸ‡¦ðŸ‡º",
  "62": "ðŸ‡®ðŸ‡©", "63": "ðŸ‡µðŸ‡­", "64": "ðŸ‡³ðŸ‡¿", "65": "ðŸ‡¸ðŸ‡¬", "66": "ðŸ‡¹ðŸ‡­", "81": "ðŸ‡¯ðŸ‡µ",
  "82": "ðŸ‡°ðŸ‡·", "84": "ðŸ‡»ðŸ‡³", "86": "ðŸ‡¨ðŸ‡³", "90": "ðŸ‡¹ðŸ‡·", "91": "ðŸ‡®ðŸ‡³", "92": "ðŸ‡µðŸ‡°",
  "93": "ðŸ‡¦ðŸ‡«", "94": "ðŸ‡±ðŸ‡°", "95": "ðŸ‡²ðŸ‡²", "98": "ðŸ‡®ðŸ‡·", "211": "ðŸ‡¸ðŸ‡¸", "212": "ðŸ‡²ðŸ‡¦",
  "213": "ðŸ‡©ðŸ‡¿", "216": "ðŸ‡¹ðŸ‡³", "218": "ðŸ‡±ðŸ‡¾", "220": "ðŸ‡¬ðŸ‡²", "221": "ðŸ‡¸ðŸ‡³", "222": "ðŸ‡²ðŸ‡·",
  "223": "ðŸ‡²ðŸ‡±", "224": "ðŸ‡¬ðŸ‡³", "225": "ðŸ‡¨ðŸ‡®", "226": "ðŸ‡§ðŸ‡«", "227": "ðŸ‡³ðŸ‡ª", "228": "ðŸ‡¹ðŸ‡¬",
  "229": "ðŸ‡§ðŸ‡¯", "230": "ðŸ‡²ðŸ‡º", "231": "ðŸ‡±ðŸ‡·", "232": "ðŸ‡¸ðŸ‡±", "233": "ðŸ‡¬ðŸ‡­", "234": "ðŸ‡³ðŸ‡¬",
  "235": "ðŸ‡¹ðŸ‡©", "236": "ðŸ‡¨ðŸ‡«", "237": "ðŸ‡¨ðŸ‡²", "238": "ðŸ‡¨ðŸ‡»", "239": "ðŸ‡¸ðŸ‡¹", "240": "ðŸ‡¬ðŸ‡¶",
  "241": "ðŸ‡¬ðŸ‡¦", "242": "ðŸ‡¨ðŸ‡¬", "243": "ðŸ‡¨ðŸ‡©", "244": "ðŸ‡¦ðŸ‡´", "245": "ðŸ‡¬ðŸ‡¼", "246": "ðŸ‡®ðŸ‡´",
  "248": "ðŸ‡¸ðŸ‡¨", "249": "ðŸ‡¸ðŸ‡©", "250": "ðŸ‡·ðŸ‡¼", "251": "ðŸ‡ªðŸ‡¹", "252": "ðŸ‡¸ðŸ‡´", "253": "ðŸ‡©ðŸ‡¯",
  "254": "ðŸ‡°ðŸ‡ª", "255": "ðŸ‡¹ðŸ‡¿", "256": "ðŸ‡ºðŸ‡¬", "257": "ðŸ‡§ðŸ‡®", "258": "ðŸ‡²ðŸ‡¿", "260": "ðŸ‡¿ðŸ‡²",
  "261": "ðŸ‡²ðŸ‡¬", "262": "ðŸ‡·ðŸ‡ª", "263": "ðŸ‡¿ðŸ‡¼", "264": "ðŸ‡³ðŸ‡¦", "265": "ðŸ‡²ðŸ‡¼", "266": "ðŸ‡±ðŸ‡¸",
  "267": "ðŸ‡§ðŸ‡¼", "268": "ðŸ‡¸ðŸ‡¿", "269": "ðŸ‡°ðŸ‡²", "290": "ðŸ‡¸ðŸ‡­", "291": "ðŸ‡ªðŸ‡·", "297": "ðŸ‡¦ðŸ‡¼",
  "298": "ðŸ‡«ðŸ‡´", "299": "ðŸ‡¬ðŸ‡±", "350": "ðŸ‡¬ðŸ‡®", "351": "ðŸ‡µðŸ‡¹", "352": "ðŸ‡±ðŸ‡º", "353": "ðŸ‡®ðŸ‡ª",
  "354": "ðŸ‡®ðŸ‡¸", "355": "ðŸ‡¦ðŸ‡±", "356": "ðŸ‡²ðŸ‡¹", "357": "ðŸ‡¨ðŸ‡¾", "358": "ðŸ‡«ðŸ‡®", "359": "ðŸ‡§ðŸ‡¬",
  "370": "ðŸ‡±ðŸ‡¹", "371": "ðŸ‡±ðŸ‡»", "372": "ðŸ‡ªðŸ‡ª", "373": "ðŸ‡²ðŸ‡©", "374": "ðŸ‡¦ðŸ‡²", "375": "ðŸ‡§ðŸ‡¾",
  "376": "ðŸ‡¦ðŸ‡©", "377": "ðŸ‡²ðŸ‡¨", "378": "ðŸ‡¸ðŸ‡²", "379": "ðŸ‡»ðŸ‡¦", "380": "ðŸ‡ºðŸ‡¦", "381": "ðŸ‡·ðŸ‡¸",
  "382": "ðŸ‡²ðŸ‡ª", "383": "ðŸ‡½ðŸ‡°", "385": "ðŸ‡­ðŸ‡·", "386": "ðŸ‡¸ðŸ‡®", "387": "ðŸ‡§ðŸ‡¦", "389": "ðŸ‡²ðŸ‡°",
  "420": "ðŸ‡¨ðŸ‡¿", "421": "ðŸ‡¸ðŸ‡°", "423": "ðŸ‡±ðŸ‡®", "500": "ðŸ‡«ðŸ‡°", "501": "ðŸ‡§ðŸ‡¿", "502": "ðŸ‡¬ðŸ‡¹",
  "503": "ðŸ‡¸ðŸ‡»", "504": "ðŸ‡­ðŸ‡³", "505": "ðŸ‡³ðŸ‡®", "506": "ðŸ‡¨ðŸ‡·", "507": "ðŸ‡µðŸ‡¦", "508": "ðŸ‡µðŸ‡²",
  "509": "ðŸ‡­ðŸ‡¹", "590": "ðŸ‡¬ðŸ‡µ", "591": "ðŸ‡§ðŸ‡´", "592": "ðŸ‡¬ðŸ‡¾", "593": "ðŸ‡ªðŸ‡¨", "594": "ðŸ‡¬ðŸ‡«",
  "595": "ðŸ‡µðŸ‡¾", "596": "ðŸ‡²ðŸ‡¶", "597": "ðŸ‡¸ðŸ‡·", "598": "ðŸ‡ºðŸ‡¾", "599": "ðŸ‡¨ðŸ‡¼", "670": "ðŸ‡¹ðŸ‡±",
  "672": "ðŸ‡³ðŸ‡«", "673": "ðŸ‡§ðŸ‡³", "674": "ðŸ‡³ðŸ‡·", "675": "ðŸ‡µðŸ‡¬", "676": "ðŸ‡¹ðŸ‡´", "677": "ðŸ‡¸ðŸ‡§",
  "678": "ðŸ‡»ðŸ‡º", "679": "ðŸ‡«ðŸ‡¯", "680": "ðŸ‡µðŸ‡¼", "681": "ðŸ‡¼ðŸ‡«", "682": "ðŸ‡¨ðŸ‡°", "683": "ðŸ‡³ðŸ‡º",
  "685": "ðŸ‡¼ðŸ‡¸", "686": "ðŸ‡°ðŸ‡®", "687": "ðŸ‡³ðŸ‡¨", "688": "ðŸ‡¹ðŸ‡»", "689": "ðŸ‡µðŸ‡«", "690": "ðŸ‡¹ðŸ‡°",
  "691": "ðŸ‡«ðŸ‡²", "692": "ðŸ‡²ðŸ‡­", "850": "ðŸ‡°ðŸ‡µ", "852": "ðŸ‡­ðŸ‡°", "853": "ðŸ‡²ðŸ‡´", "855": "ðŸ‡°ðŸ‡­",
  "856": "ðŸ‡±ðŸ‡¦", "880": "ðŸ‡§ðŸ‡©", "886": "ðŸ‡¹ðŸ‡¼", "960": "ðŸ‡²ðŸ‡»", "961": "ðŸ‡±ðŸ‡§", "962": "ðŸ‡¯ðŸ‡´",
  "963": "ðŸ‡¸ðŸ‡¾", "964": "ðŸ‡®ðŸ‡¶", "965": "ðŸ‡°ðŸ‡¼", "966": "ðŸ‡¸ðŸ‡¦", "967": "ðŸ‡¾ðŸ‡ª", "968": "ðŸ‡´ðŸ‡²",
  "970": "ðŸ‡µðŸ‡¸", "971": "ðŸ‡¦ðŸ‡ª", "972": "ðŸ‡®ðŸ‡±", "973": "ðŸ‡§ðŸ‡­", "974": "ðŸ‡¶ðŸ‡¦", "975": "ðŸ‡§ðŸ‡¹",
  "976": "ðŸ‡²ðŸ‡³", "977": "ðŸ‡³ðŸ‡µ", "992": "ðŸ‡¹ðŸ‡¯", "993": "ðŸ‡¹ðŸ‡²", "994": "ðŸ‡¦ðŸ‡¿", "995": "ðŸ‡¬ðŸ‡ª",
  "996": "ðŸ‡°ðŸ‡¬", "998": "ðŸ‡ºðŸ‡¿"
};

  function getPrefix(number) {
    for (let i = 4; i >= 1; i--) {
      const sub = number.slice(0, i);
      if (countryFlags[sub]) return sub;
    }
    return "1"; 
  }

  const pesan = args.join` `;
  const oi = `*Â» INFO :* ${pesan}`;
  let teks = `*!  MENCION GENERAL  !*\n  *PARA ${participants.length} MIEMBROS* âš¡\n\n ${oi}\n\nâ”â•â”…â”…â•â”…â•=ÍŸÍŸÍž${botname} â•â”…â•â”…â”…â•â•â•â˜¾\n`;

  for (const mem of participants) {
    const number = mem.id.split('@')[0];
    const prefix = getPrefix(number);
    const flag = countryFlags[prefix] || "ðŸ³ï¸â€ðŸŒˆ";
    teks += `â”ƒâ¤ÍŸÍžÍŸÍž${flag} @${number}\n`;
  }

  teks += `â”—â”…â•â•â”…â•â”… *${vs}* â•â”…â•â”…â”…â•â”…â˜¾`;

  conn.sendMessage(m.chat, { text: teks, mentions: participants.map(p => p.id) }, { quoted: m });
};

handler.help = ['todos *<mensaje opcional>*'];
handler.tags = ['group'];
handler.command = ['todos', 'invocar', 'tagall'];
handler.group = true;

export default handler;